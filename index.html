<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>


    <title>Daily Budget Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2a2a2a 100%);
            min-height: 100vh;
            padding: 0px;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
    max-width: 100%;
    margin: 0;
    padding: 0;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 0;
    box-shadow: none;
    border: none;
}
html, body {
    max-width: 100%;
    overflow-x: hidden;
}

@media (max-width: 430px) {
    body, .amount, .transaction-description, .transaction-info, .input-group label, .btn, select, input {
        font-size: 14px !important;
    }

    .header h1 {
        font-size: 10px;
    }

    .card {
        padding: 15px;
    }

    .transaction {
        padding: 10px;
    }

    .input-group input,
    .input-group select {
        padding: 10px;
    }
}



        .header {
            background: linear-gradient(135deg, #272727, #0c0c0c);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-100px); }
        }

        .header h1 {
            font-size: 1.9em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 0.8em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .card {
            background: rgba(9, 9, 9, 0.8);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            transition: all 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            color: white;
            margin-bottom: 15px;
            font-size: clamp(1.1rem, 2.5vw, 1.3rem);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }

        .income-icon { background: #27ae60; }
        .expense-icon { background: #e74c3c; }
        .balance-icon { background: #3498db; }
        .budget-icon { background: #f39c12; }

        .amount {
            font-size: 2.8em;
            font-weight: bold;
            margin: 10px 0;
        }

        .amount.positive { color: #27ae60; }
        .amount.negative { color: #e74c3c; }
        .amount.neutral { color: #3498db; }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: clamp(14px, 2.5vw, 16px);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group select option {
            background: #333;
            color: white;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .transactions {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
        }

        .transaction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .transaction:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-description {
            font-weight: 500;
            color: white;
            margin-bottom: 5px;
        }

        .transaction-info {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1em;
            margin-right: 10px;
        }

        .transaction-amount.income {
            color: #27ae60;
        }

        .transaction-amount.expense {
            color: #e74c3c;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #4c4c4c;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #51cf66, #40c057);
            transition: width 0.3s ease;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: rgb(56, 56, 56);
            color: #d1d1d1;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        .modal-content h2 {
            color: white;
            margin-bottom: 20px;
            font-size: clamp(1.3rem, 3vw, 1.8rem);
        }

        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .floating-action-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .quick-stat {
            text-align: center;
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quick-stat-value {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            font-weight: bold;
            color: #60a5fa;
        }

        .quick-stat-label {
            font-size: clamp(0.7rem, 1.5vw, 0.8rem);
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .filters {
                justify-content: center;
            }
            
            .transaction {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        .floating-action-wrapper {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}

.quick-popup-menu {
  position: absolute;
  bottom: 70px;
  right: 0;
  display: none;
  flex-direction: column;
  gap: 10px;
  background: rgba(0, 0, 0, 0.8);
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
}
.shortcut-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}


.transaction.over-budget {
    background-color: rgba(0, 191, 255, 0.12) !important;
    border-left: 5px solid #00bfff;
}

.transaction-amount.over-budget {
    color: #00bfff !important;
    font-weight: bold;
}
.transaction-card {
    padding: 0 !important;
    margin: 0 !important;
    border-radius: 0 !important;
    width: 100% !important;
    box-shadow: none !important;
}

.transactions {
    padding: 0 10px !important;
}

.transaction {
    margin: 0;
    border-radius: 0;
    width: 100%;
    padding: 10px 12px;
    box-sizing: border-box;
}

/* Blur background when modal is open */
body.modal-open {
  overflow: hidden;
}

.modal-blur {
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px); /* for Safari */
  background-color: rgba(0, 0, 0, 0.3);
}



.transaction-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  border-bottom: 1px solid #ccc;
}

.transaction {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    margin-bottom: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    transform: translateX(0);
    cursor: grab;
}

.transaction:active {
    cursor: grabbing;
}

.transaction.swiping {
    transition: none;
}

.transaction.swipe-left {
    transform: translateX(-80px);
}

.transaction-delete-area {
    position: absolute;
    right: -80px;
    top: 0;
    bottom: 0;
    width: 80px;
    background: #e74c3c;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.transaction.swipe-left .transaction-delete-area {
    right: 0;
}

.transaction-delete-area:hover {
    background: #c0392b;
}




.calendar-icon-filter {
  display: flex;
  justify-content: flex-start; /* <-- align left */
  margin: 10px 0 15px;
  position: relative;
}


.calendar-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: white;
  font-size: 18px;
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.calendar-button:hover {
  background: rgba(255, 255, 255, 0.1);
}

#historyDatePicker {
  opacity: 0;
  position: absolute;
  right: 0;
  top: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.transaction-delete-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 26px;
  height: 26px;
  background-color: #e74c3c;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  z-index: 1;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  transition: background-color 0.3s ease;
}

.transaction-delete-btn:hover {
  background-color: #c0392b;
}

.transaction-delete-btn svg {
  width: 14px;
  height: 14px;
  fill: white;
}

.transaction.over-budget {
  background-color: rgba(0, 191, 255, 0.12) !important;
  border-left: 5px solid #00bfff;
}

.transaction-amount.over-budget {
  color: #00bfff !important;
  font-weight: bold;
}

.transaction.over-budget {
  background-color: rgba(0, 191, 255, 0.12) !important;
  border-left: 5px solid #00bfff;
}

.transaction-amount.over-budget {
  color: #00bfff !important;
  font-weight: bold;
}

.mini-delete-btn {
  width: 30px;
  height: 30px;
  background-color: #e74c3c;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  transition: background-color 0.3s ease;
}

.mini-delete-btn:hover {
  background-color: #c0392b;
}

.trash-icon {
  width: 16px;
  height: 16px;
  pointer-events: none;
}

.budget-buttons-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: nowrap;
  justify-content: flex-start;
}

.undo-circle {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, #e74c3c, #c0392b);
  border-radius: 50%;
  border: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transition: transform 0.2s ease;
  flex-shrink: 0; /* important to prevent wrapping */
}

.undo-circle:hover {
  transform: scale(1.1);
}

.undo-icon {
  width: 20px;
  height: 20px;
  pointer-events: none;
}
.filter-scroll-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin-bottom: 15px;
}

.filter-scroll-row {
  display: inline-flex;
  gap: 10px;
  padding: 10px 0;
  min-width: max-content;
}

.filter-scroll-container::-webkit-scrollbar {
  display: none; /* Hide scrollbar */
}

.filter-btn {
  white-space: nowrap;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 20px;
  border: 2px solid #1559b3;
  background: #1e1e1e;
  color: #d1d1d1;
  cursor: pointer;
  transition: all 0.3s ease;
}

.filter-btn.active {
  background: #667eea;
  color: white;
}




/* New design */

/* 🌑 Base Font & Body Setup */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

:root {
  --primary-blue: #0f5cae;
  --undo-red: #e74c3c;
}

body {
  font-family: 'Inter', sans-serif !important;
  background: linear-gradient(to bottom, #050505, #0e0e0e) fixed;
  color: #e3f2fd;
  touch-action: manipulation;
  transition: background 0.3s ease;
}

/* 🔷 All Buttons Except Undo */
.btn:not(.undo-circle):not(.transaction-delete-btn):not(.mini-delete-btn) {
  background: linear-gradient(to right, var(--primary-blue), #063b7b);
  color: #fff !important;
  border: none !important;
  box-shadow: 0 4px 14px rgba(15, 92, 174, 0.3);
  transition: transform 0.2s ease, box-shadow 0.3s ease;
}
.btn:not(.undo-circle):hover {
  transform: scale(1.03);
  box-shadow: 0 6px 22px rgba(15, 92, 174, 0.5);
}
.btn:not(.undo-circle):active {
  transform: scale(0.96);
}

/* 📋 Transaction Container */
.transaction {
  background: rgba(255, 255, 255, 0.035);
  border-left: 4px solid var(--primary-blue);
  transition: background 0.25s ease, transform 0.2s ease;
  animation: fadeTransaction 0.4s ease;
}
.transaction:hover {
  background: rgba(255, 255, 255, 0.06);
  transform: translateX(6px);
}
@keyframes fadeTransaction {
  0% { opacity: 0; transform: translateY(12px); }
  100% { opacity: 1; transform: translateY(0); }
}

/* 💠 Glassy Card Layout */
.card {
  background: rgba(15, 20, 30, 0.55);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 14px;
  backdrop-filter: blur(16px);
  box-shadow: 0 6px 22px rgba(0, 0, 0, 0.5);
  animation: fadeCard 0.35s ease;
}
@keyframes fadeCard {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 🔘 Floating Action Button */
.floating-action-btn {
  background: linear-gradient(to right, var(--primary-blue), #063b7b);
  box-shadow: 0 4px 16px rgba(15, 92, 174, 0.4);
  transition: transform 0.2s ease;
}
.floating-action-btn:hover {
  transform: scale(1.08);
}
.floating-action-btn:active {
  transform: scale(0.94);
}

/* 🧊 Inputs */
.input-group input,
.input-group select {
  background: rgba(255, 255, 255, 0.05);
  color: #cbe4ff;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: border 0.2s ease, box-shadow 0.2s ease;
}
.input-group input:focus,
.input-group select:focus {
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 3px rgba(15, 92, 174, 0.3);
}

/* 📊 Stats Card */
.stat-card {
  background: linear-gradient(135deg, #112c44, #174471);
  color: white;
  box-shadow: 0 4px 18px rgba(15, 92, 174, 0.2);
}

/* 📦 Modal */
.modal-content {
  background: rgba(20, 30, 40, 0.92);
  border-radius: 14px;
  border: 1px solid rgba(255, 255, 255, 0.07);
  box-shadow: 0 22px 65px rgba(0, 0, 0, 0.6);
  animation: modalFade 0.3s ease;
}
@keyframes modalFade {
  from { opacity: 0; transform: scale(0.0); }
  to { opacity: 1; transform: scale(0); }
}

/* 🎯 Filter Button Active */
.filter-btn.active {
  background: var(--primary-blue);
  color: white !important;
  box-shadow: 0 0 6px rgba(15, 92, 174, 0.4);
}

/* 🔴 UNDO BUTTON – Important, Keep Red */
.undo-circle {
  background: linear-gradient(to right, var(--undo-red), #a93128);
  box-shadow: 0 0 14px rgba(231, 76, 60, 0.5);
  transition: transform 0.2s ease;
}
.undo-circle:hover {
  transform: scale(1.1);
}
.undo-circle:active {
  transform: scale(0.95);
}

/* ❌ Delete Buttons */
.transaction-delete-btn,
.mini-delete-btn {
  background: linear-gradient(to right, var(--undo-red), #b32a2a);
  box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
}

/* 💹 Over-Budget Transaction */
.transaction.over-budget {
  background: rgba(15, 92, 174, 0.08);
  border-left: 4px solid var(--primary-blue);
}
.transaction-amount.over-budget {
  color: var(--primary-blue);
}

/* 📱 Mobile Tap Effect - All Interactive Elements */
.btn,
.floating-action-btn,
.transaction,
.filter-btn,
.undo-circle {
  will-change: transform;
  touch-action: manipulation;
  transition: all 0.2s ease;
}





    </style>
</head>
<body>
    <!-- Long Press Delete Modal -->
<div id="longPressModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('longPressModal')">&times;</span>
      <h2>Delete this transaction?</h2>
      <button class="btn danger" onclick="confirmDelete()">🗑️ Delete</button>
      <button class="btn" onclick="closeModal('longPressModal')">❌ Cancel</button>
    </div>
  </div>
  
    
    <div class="floating-action-wrapper">
        <button class="floating-action-btn" onclick="toggleQuickMenu()">+</button>
        <div id="quickActionMenu" class="quick-popup-menu">
          <button class="btn" onclick="showListModal(); hideQuickMenu();">📋 Create List</button>
          <button class="btn danger" onclick="showQuickExpense(); hideQuickMenu();">💸 Quick Expense</button>
          <button class="btn success" onclick="showQuickIncome(); hideQuickMenu();">💰 Quick Income</button>
        </div>
      </div>
      
              
          
        <div id="quickActionMenu" class="quick-popup-menu">
            <button class="btn" onclick="showListModal(); hideQuickMenu();">📋 Create List</button>

          <button class="btn danger" onclick="showQuickExpense(); hideQuickMenu();">💸 Quick Expense</button>
          <button class="btn success" onclick="showQuickIncome(); hideQuickMenu();">💰 Quick Income</button>
        </div>
      </div>
      
      
      
      

    <div class="container">
        <div class="header">
            <h1>💰 Daily Budget Tracker</h1>
            <p>Manage your finances like a pro with LKr currency</p>
        </div>
        

        <div class="dashboard">
            <!-- Styled Search-Like Date Picker -->
<div class="calendar-search-bar" style="display: flex; justify-content: center; margin-top: 20px;">
    <div style="position: relative; width: 300px;">
      <span style="position: absolute; top: 50%; left: 12px; transform: translateY(-50%); color: #ccc; font-size: 18px;">🔍</span>
      <input
  type="text"
  id="searchDateDisplay"
  readonly
  style="width: 100%; padding: 10px 10px 10px 40px; border-radius: 8px; border: 1px solid #555; background: rgba(255,255,255,0.05); color: white; font-size: 16px; text-align: center;"
  onclick="document.getElementById('hiddenDatePicker').click();"
/>

      <input
        type="date"
        id="hiddenDatePicker"
        onchange="setDate(this.value)"
        style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;"
      />
    </div>
  </div>
  
            <button class="btn" onclick="openQuickListPopup()" style="margin: 15px 0;">🛒 My List</button>
            <!-- Quick View List Modal -->
<div id="quickListPopup" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('quickListPopup')">&times;</span>
      <h2>🛍️ My Shopping List</h2>
      <ul id="quickPopupList" style="margin-top: 15px; color: white; list-style: none; padding-left: 0;"></ul>
    </div>
  </div>
  
  <div id="transactionOptionsModal" class="modal">
  <div class="modal-content">
    <h2>Transaction Options</h2>
    <button class="btn danger" onclick="confirmDeleteTransaction()">🗑️ Delete</button>
    <button class="btn" onclick="closeModal('transactionOptionsModal')">❌ Cancel</button>
  </div>
</div>


            
            
            <!-- Budget Overview -->
            <div class="card">
                <h3><span class="icon budget-icon">📊</span>Budget Overview</h3>
                <div class="amount neutral" id="totalBudget">0 LKR</div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="budgetProgress"></div>
                </div>
                
                <div class="input-group">
                    <label>Set Daily Budget</label>
                    <input type="number" id="budgetInput" placeholder="Enter daily budget in LKR">
                </div>
                <div class="budget-buttons-row">
                    <button class="btn success" onclick="setBudget()">Set Budget</button>
                    <button class="btn danger" onclick="clearBudget()">Clear Budget</button>
                    <button class="btn undo-circle" onclick="undoLastBudget()" title="Undo Last Budget">
                      <svg viewBox="0 0 24 24" class="undo-icon">
                        <path fill="white" d="M12 5V1L7 6l5 5V7c3.86 0 7 3.14 7 7 0 .34-.03.67-.08 1h2.02c.04-.33.06-.66.06-1 0-4.97-4.03-9-9-9z"/>
                      </svg>
                    </button>
                  </div>
                  
                  


            </div>
            

            <!-- Total Balance -->
            <div class="card">
                <h3><span class="icon balance-icon">💳</span>Current Balance</h3>
                <div class="amount neutral" id="balance">0 LKR</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalIncome">0</div>
                        <div class="stat-label">Income</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalExpense">0</div>
                        <div class="stat-label">Expenses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="remainingBudget">0</div>
                        <div class="stat-label">Remaining</div>
                    </div>
                    
                </div>
            </div>
            

            <!-- Add Transaction -->
            <!-- Add Transaction -->
<div class="card">
    <h3><span class="icon income-icon">➕</span>Add Transaction</h3>
  
    <div class="input-group">
      <label>Description</label>
      <input type="text" id="description" placeholder="What did you buy/receive?">
    </div>
  
    <div class="input-group">
      <label>Amount (LKR)</label>
      <input type="number" id="amount" placeholder="Enter amount">
    </div>
  
    <div class="input-group">
      <label>Category</label>
      <select id="category">
        <option value="Breakfast">Breakfast</option>
        <option value="Lunch">Lunch</option>
        <option value="Dinner">Dinner</option>
        <option value="Snacks">Snacks</option>
        <option value="Transport">Transport</option>
        <option value="Shopping">Shopping</option>
        <option value="Bills">Bills</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Health">Health</option>
        <option value="Income">Income</option>
        <option value="Other">Other</option>
      </select>
    </div>
  
    <div class="input-group">
      <label>Type</label>
      <select id="type">
        <option value="expense">💸 Expense</option>
        <option value="income">💰 Income</option>
      </select>
    </div>
  
    <button class="btn success" onclick="addTransaction()">Add Transaction</button>
    
  </div>
  
            

        <!-- Transactions Section -->
        <div class="card transaction-fullscreen">

            <h3><span class="icon balance-icon">📋</span>Transaction History</h3>
            
              
              
            
            
            
            <div class="filter-scroll-container">
                <div class="filter-scroll-row">
                  <button class="filter-btn active" onclick="filterTransactions('all')">All</button>
                  <button class="filter-btn" onclick="filterTransactions('today')">Today</button>
                  <button class="filter-btn" onclick="filterTransactions('yesterday')">Yesterday</button>
                  <button class="filter-btn" onclick="filterTransactions('week')">This Week</button>
                </div>
              </div>
              
            

            <div class="transactions" id="transactionsList">
                <p style="text-align: center; color: #666; padding: 20px;">No transactions yet. Add your first transaction above!</p>
            </div>
        </div>
    </div>



   

      
      
    <!-- Quick Actions -->
    <!-- Quick Actions -->
<div class="card shortcut-box" style="margin: 20px;">
    <h3><span class="icon expense-icon">⚡</span>Shortcut Actions</h3>
    <div class="shortcut-grid">
        <button class="btn danger" onclick="clearAllData()">Clear All</button>
        <button class="btn" onclick="exportData()">Export Data</button>
        <button class="btn" onclick="showStatistics()">View Stats</button>
        <button class="btn" onclick="importData()">Restore Backup</button>
    </div>
</div>

</div>

    <!-- Quick Expense Modal -->
   <!-- Quick Expense Modal -->
<!-- Quick Expense Modal -->
<div id="quickExpenseModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('quickExpenseModal')">&times;</span>
      <h2>Quick Expense</h2>
  
      <div class="input-group">
        <label>Amount (LKR)</label>
        <input type="number" id="quickExpenseAmount" placeholder="Enter amount">
      </div>
  
      <div class="input-group">
        <label>What for?</label>
        <input id="quickExpenseDesc" list="whatForSuggestions" placeholder="e.g., Lunch or type your own">
        <datalist id="whatForSuggestions">
          <option value="Breakfast"> 
          <option value="Lunch">
          <option value="Snacks">
          <option value="Dinner"> 
          <option value="Shopping">
          <option value="Starfoodcity">
          <option value="Dailyfoodcity">
          <option value="Cargills">
          <option value="Northway">
          <option value="keels">
          <option value="Transport">
          <option value="CEB Bills">
          <option value="Telephone Bills">
          <option value="Insurence">
          <option value="Entertainment">
          <option value="Health">
        </datalist>
      </div>
  
      <button class="btn danger" onclick="addQuickExpense()">Add Expense</button>
      <button class="btn warning" onclick="openScanBillModal()">📷 Scan Bill</button>
    </div>
  </div>
  
  <div id="scanBillModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('scanBillModal')">&times;</span>
      <h2>📷 Scan Bill</h2>
  
      <div class="input-group">
        <label>Upload Bill Image</label>
        <input type="file" id="billImageInput" accept="image/*" onchange="processBillImage(event)">
      </div>
  
      <p id="scanResult" style="color: #ccc; margin-top: 10px;">
        Total will appear here after scanning...
      </p>
  
      <button class="btn success" onclick="useScannedAmount()">Use Amount</button>
    </div>
  </div>
  

    

    <!-- Quick Income Modal -->
    <div id="quickIncomeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('quickIncomeModal')">&times;</span>
            <h2>Quick Income</h2>
            <div class="input-group">
                <label>Amount (LKR)</label>
                <input type="number" id="quickIncomeAmount" placeholder="Enter amount">
            </div>
            <div class="input-group">
                <label>Source</label>
                <input type="text" id="quickIncomeDesc" placeholder="Salary, gift, etc.">
            </div>
            <button class="btn success" onclick="addQuickIncome()">Add Income</button>
        </div>
    </div>
    <!-- Create List Modal -->
     
<div id="createListModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('createListModal')">&times;</span>
      <h2>Create Buying List</h2>
  
      <div class="input-group">
        <input type="text" id="listItemInput" placeholder="Enter item to buy">
        <select id="quantityUnit" class="btn" style="margin-top: 10px;">
            <option value="500g">500 g</option>
            <option value="250g">250 g</option>
            <option value="1kg">1 Kg</option>
            <option value="1.5kg">1.5 Kg</option>
            <option value="2kg">2 Kg</option>
            <option value="2.5 kg">2.5 kg</option>
            <option value="1L">1 Liter</option>
            <option value="2L">2 Liters</option>
            <option value="1pcs">1 Piece</option>
            <option value="2pcs">2 Pieces</option>
            <option value="5pcs">5 Pieces</option>
            <option value="12pcs">12 Pieces</option>
            
           
            <option value="custom">Custom</option>
          </select>
          
  
</select>

        <button class="btn success" onclick="addListItem()">➕ Add</button>
        <button class="btn danger" onclick="clearBuyingList()" style="margin-top: 10px;">🧹 Clear List</button>

      </div>
  
      <ul id="buyingList" style="margin-top: 15px; color: white; list-style: none; padding-left: 0;"></ul>
    </div>
  </div>
  

    <!-- Statistics Modal -->
    <div id="statisticsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('statisticsModal')">&times;</span>
            <h2>📊 Detailed Statistics</h2>
            <div id="statisticsContent"></div>
        </div>
    </div>

    <script>

function addTransaction() {
  const description = document.getElementById('description').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  const category = document.getElementById('category').value;
  const type = document.getElementById('type').value;

  if (!description || isNaN(amount) || amount <= 0 || !category || !type) {
    alert("Please fill in all fields correctly.");
    return;
  }

  const now = new Date();
  const date = selectedDate;
  const time = now.toLocaleTimeString();

  const transaction = {
    id: Date.now(),
    description,
    amount,
    category,
    type,
    date,
    time
  };

  transactions.push(transaction);

  // Save to correct date bucket
  allData[selectedDate] = { transactions, dailyBudget };
  localStorage.setItem('allBudgetData', JSON.stringify(allData));

  // Clear inputs
  document.getElementById('description').value = '';
  document.getElementById('amount').value = '';
  document.getElementById('category').value = '';
  document.getElementById('type').value = 'expense';

  updateDisplay();
}



let quickMenuTimer;

function handleFloatingButtonClick() {
  if (quickMenuTimer) {
    clearTimeout(quickMenuTimer);
    quickMenuTimer = null;
    toggleQuickMenu(); // Expand menu on second tap
    return;
  }

  // First tap: open Quick Expense
  showQuickExpense();

  // If tapped again within 500ms → show full menu instead
  quickMenuTimer = setTimeout(() => {
    quickMenuTimer = null;
  }, 500);
}

function triggerDatePicker() {
    document.getElementById('historyDatePicker').click();
}




let scannedAmount = null;
let scannedShop = null;

function openScanBillModal() {
  document.getElementById("scanBillModal").style.display = "block";
}

async function processBillImage(event) {
  const file = event.target.files[0];
  if (!file) return;

  document.getElementById("scanResult").textContent = "⏳ Scanning bill, please wait...";

  try {
    // OCR with Tesseract.js
    const { data: { text } } = await Tesseract.recognize(file, 'eng');

    // Split into lines
    const lines = text.split("\n").map(l => l.trim()).filter(l => l);

    // Guess shop name → first non-empty line
    let shopName = lines[0] || "Unknown Shop";

    // Find line with "total" / "subtotal" / "amount"
    let totalLine = lines.find(l => /total|subtotal|amount/i.test(l));
    let amount = null;

    if (totalLine) {
      const matches = totalLine.match(/(\d+(\.\d{1,2})?)/g);
      if (matches) {
        // Pick biggest number if multiple
        amount = matches.map(Number).sort((a, b) => b - a)[0];
      }
    }

    scannedAmount = amount;
    scannedShop = shopName;

    document.getElementById("scanResult").innerHTML = `
      🏪 Shop: <b>${shopName}</b><br>
      💰 Amount: <b>${amount ? amount + " LKR" : "Not found"}</b>
    `;
  } catch (err) {
    document.getElementById("scanResult").textContent = "❌ Failed to scan: " + err.message;
  }
}

function useScannedAmount() {
  if (!scannedAmount) {
    alert("No amount detected yet!");
    return;
  }

  // Auto-fill Quick Expense fields
  document.getElementById("quickExpenseAmount").value = scannedAmount;
  document.getElementById("quickExpenseDesc").value = scannedShop;

  closeModal("scanBillModal");
}










function setDate(dateString) {
    selectedDate = dateString;
    
    // Load data for selected date from allData structure
    transactions = allData[selectedDate]?.transactions || [];
    dailyBudget = allData[selectedDate]?.dailyBudget || 0;
    
    // Sync all date inputs
    if (document.getElementById('historyDatePicker'))
        document.getElementById('historyDatePicker').value = selectedDate;
    if (document.getElementById('bottomDatePicker'))
        document.getElementById('bottomDatePicker').value = selectedDate;
    if (document.getElementById('hiddenDatePicker'))
        document.getElementById('hiddenDatePicker').value = selectedDate;
    if (document.getElementById('searchDateDisplay'))
        document.getElementById('searchDateDisplay').value = new Date(selectedDate).toLocaleDateString();
    
    updateDisplay();
}

// Automatically load today
window.addEventListener('load', () => {
    const today = new Date().toLocaleDateString('en-CA');

    setDate(today); // Default to today
    document.getElementById('historyDatePicker').value = today;
});




let longPressTimer;
let longPressTransactionId = null;

let lastTap = 0;
let doubleTapTransactionId = null;

function setupDoubleTapListeners() {
  const container = document.getElementById("transactionsList");

  container.addEventListener("touchend", function (e) {
    const transaction = e.target.closest(".transaction");
    if (!transaction) return;

    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;

    if (tapLength < 500 && tapLength > 0) {
      // Detected a double tap
      doubleTapTransactionId = parseInt(transaction.getAttribute("data-id"));
      showModal("longPressModal");
    }

    lastTap = currentTime;
  });
}

function showModal(id) {
  document.getElementById(id).style.display = "block";
  document.body.classList.add("modal-open");
}

function confirmDelete() {
  if (doubleTapTransactionId !== null) {
    deleteTransaction(doubleTapTransactionId);
    closeModal('longPressModal');
    doubleTapTransactionId = null;
  }
}


        // These are used to track whether it’s the first time and which IDs are checked.
let isFirstBudgetSet = true;
let checkedOverBudgetIds = JSON.parse(localStorage.getItem('checkedOverBudgetIds') || '[]');
// This variable will hold the sum of the over-budget amounts that are ticked.
let adjustOverBudget = 0;


        function openQuickListPopup() {
    renderQuickPopupList();
    document.getElementById('quickListPopup').style.display = 'block';
}
function openQuickListPopup() {
    renderQuickPopupList();
    document.getElementById('quickListPopup').style.display = 'block';
    document.getElementById('quickListPopup').classList.add('modal-blur');
    document.body.classList.add('modal-open');
}


function renderQuickPopupList() {
    const listEl = document.getElementById('quickPopupList');
    if (buyingItems.length === 0) {
        listEl.innerHTML = '<p style="color: #aaa;">No items yet.</p>';
        return;
    }

    listEl.innerHTML = buyingItems.map((item, index) => `
        <li style="margin: 12px 0;">
            <label style="display: flex; align-items: center; gap: 12px;">
                <input type="checkbox" onchange="toggleListItem(${index}); renderQuickPopupList();" ${item.checked ? 'checked' : ''} style="width: 24px; height: 24px;">
                <span style="
                    text-decoration: ${item.checked ? 'line-through' : 'none'};
                    color: ${item.checked ? 'red' : 'white'};
                    font-weight: bold;
                    font-size: 18px;">
                    ${item.text} <span style="font-size: 16px; color: #ccc;">(${item.unit})</span>
                </span>
            </label>
        </li>
    `).join('');
}

        let buyingItems = [];

function showListModal() {
    document.getElementById('createListModal').style.display = 'block';
    renderBuyingList();
}

function addListItem() {
    const input = document.getElementById('listItemInput');
    const unit = document.getElementById('quantityUnit').value;
    const text = input.value.trim();
    if (!text) return;

    buyingItems.push({ text, unit, checked: false });
    input.value = '';
    renderBuyingList();
    saveBuyingList();
}

function deleteLastItem() {
  if (buyingItems.length === 0) {
    alert("No item to delete!");
    return;
  }

  buyingItems.pop();
  saveBuyingList();
  renderBuyingList();
}



function renderBuyingList() {
  const listEl = document.getElementById('buyingList');

  if (buyingItems.length === 0) {
    listEl.innerHTML = '<p style="color: #aaa;">No items yet.</p>';
    return;
  }

  listEl.innerHTML = buyingItems.map((item, index) => {
    const isLast = index === buyingItems.length - 1;
    return `
      <li style="margin: 12px 0; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: bold; font-size: 18px; color: white;">
          ${item.text} <span style="font-size: 16px; color: #ccc;">(${item.unit})</span>
        </span>
        ${isLast ? `
          <button class="mini-delete-btn" onclick="deleteLastItem()" title="Delete">
            <svg class="trash-icon" viewBox="0 0 24 24">
              <path fill="white" d="M9 3v1H4v2h16V4h-5V3H9zm-2 5v12a1 1 0 001 1h8a1 1 0 001-1V8H7zm2 2h2v8H9v-8zm4 0h2v8h-2v-8z"/>
            </svg>
          </button>` : ''}
      </li>
    `;
  }).join('');
}





function clearBuyingList() {
    if (confirm("Are you sure you want to clear the entire list?")) {
        buyingItems = [];
        saveBuyingList();
        renderBuyingList();
        renderHomeQuickList?.();
    }
}


function toggleListItem(index) {
    buyingItems[index].checked = !buyingItems[index].checked;
    renderBuyingList();
    saveBuyingList();
}

function saveBuyingList() {
    localStorage.setItem('buyingList', JSON.stringify(buyingItems));
}

function loadBuyingList() {
    const saved = localStorage.getItem('buyingList');
    if (saved) {
        buyingItems = JSON.parse(saved);
    }
}

// Load list on page load
window.addEventListener('load', loadBuyingList);

        // Load from localStorage if available
// ✅ This one loads from localStorage
// Replace your current window.onload function with this:
window.onload = function() {
    // Load complete app state
    const savedState = localStorage.getItem('budgetAppState');
    if (savedState) {
        try {
            const state = JSON.parse(savedState);
            transactions = state.transactions || [];
            dailyBudget = state.dailyBudget || 0;
            checkedOverBudgetIds = state.checkedOverBudgetIds || [];
            adjustOverBudget = state.adjustOverBudget || 0;
            selectedDate = state.selectedDate || new Date().toISOString().split('T')[0];
            
            // Also load the allData structure
            const savedAllData = localStorage.getItem('allBudgetData');
            if (savedAllData) {
                allData = JSON.parse(savedAllData);
            }
        } catch (e) {
            console.error("Failed to parse saved data", e);
        }
    }
    
    // Initialize date pickers
    const today = new Date().toLocaleDateString('en-CA');

    setDate(today);
    document.getElementById('historyDatePicker').value = today;
    
    // Initialize UI components
    updateDisplay();
    initSwipeHandlers();
    setupDoubleTapListeners();
    loadBuyingList();
};

// Detect long press on transaction
function setupLongPress() {
    const transactionsList = document.getElementById('transactionsList');
    let pressTimer;
    let longPressTargetId = null;

    transactionsList.addEventListener('touchstart', function(e) {
        const target = e.target.closest('.transaction');
        if (!target) return;
        longPressTargetId = target.getAttribute('data-id');
        pressTimer = setTimeout(() => {
            showTransactionOptionsModal(longPressTargetId);
        }, 700); // 700ms long press
    });

    transactionsList.addEventListener('touchend', function() {
        clearTimeout(pressTimer);
    });

    transactionsList.addEventListener('touchmove', function() {
        clearTimeout(pressTimer); // Cancel on scroll/move
    });
}





function updateQuickStats() {
    const today = new Date().toLocaleDateString('en-CA');

    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    const todaySpent = transactions.filter(t => t.type === 'expense' && t.date === today)
        .reduce((sum, t) => sum + t.amount, 0);
    const weekSpent = transactions.filter(t => t.type === 'expense' && t.date >= weekAgo)
        .reduce((sum, t) => sum + t.amount, 0);
    const monthSpent = transactions.filter(t => t.type === 'expense' && t.date >= monthAgo)
        .reduce((sum, t) => sum + t.amount, 0);

    document.getElementById('todaySpent').textContent = todaySpent.toFixed(0);
    document.getElementById('weekSpent').textContent = weekSpent.toFixed(0);
    document.getElementById('monthSpent').textContent = monthSpent.toFixed(0);
}

        // Global variables
let allData = JSON.parse(localStorage.getItem('allBudgetData') || '{}');
let selectedDate = new Date().toISOString().split('T')[0];

let transactions = allData[selectedDate]?.transactions || [];
let dailyBudget = allData[selectedDate]?.dailyBudget || 0;
let currentFilter = 'all';
let budgetSetCount = 0; // ✅ Count how many times budget is set


        
        

        // Set daily budget
        function setBudget() {
    const budgetInput = document.getElementById('budgetInput');
    const newBudget = parseFloat(budgetInput.value);
    budgetSetCount++; // ✅ Increase count every time user sets budget


    if (isNaN(newBudget) || newBudget <= 0) {
        alert("Enter a valid amount.");
        return;
    }

    // ADD to existing daily budget (not replace)
    dailyBudget += newBudget;

// ✅ Track history of budgets
const history = JSON.parse(localStorage.getItem('budgetHistory') || '[]');
history.push(newBudget);
localStorage.setItem('budgetHistory', JSON.stringify(history));

    // Calculate adjustment from checked over-budget items
    const checkedOverBudgetAmount = transactions.filter(
        t => t.type === 'expense' &&
             t.description.toLowerCase().includes('(over budget)') &&
             checkedOverBudgetIds.includes(t.id)
    ).reduce((sum, t) => sum + t.amount, 0);

    adjustOverBudget = checkedOverBudgetAmount;

    budgetInput.value = '';
    localStorage.setItem('budgetData', JSON.stringify({ transactions, dailyBudget }));
    updateDisplay();
    
}
// 🔙 Undo the most recent budget addition
function undoLastBudget() {
    const history = JSON.parse(localStorage.getItem('budgetHistory') || '[]');

    if (history.length === 0) {
        alert("No previous budget to remove.");
        return;
    }

    const lastAmount = history[history.length - 1]; // Just peek for confirmation

    const confirmRemove = confirm(`Are you sure you want to remove the last budget amount of ${lastAmount.toFixed(2)} LKR?`);
    if (!confirmRemove) return;

    // Proceed to remove
    history.pop();
    dailyBudget -= lastAmount;
    if (dailyBudget < 0) dailyBudget = 0;

    localStorage.setItem('budgetHistory', JSON.stringify(history));
    localStorage.setItem('budgetData', JSON.stringify({ transactions, dailyBudget }));
    updateDisplay();
}








    // Update daily budget
    dailyBudget = newBudget;

    // Get today's date
    const today = new Date().toLocaleDateString('en-CA');

    // Collect today's expenses
    const todayExpenses = transactions.filter(t => t.type === 'expense' && t.date === today);

    // Rebalance today's expenses based on new budget
    let totalSoFar = 0;
    transactions = transactions.map(t => {
        if (t.type !== 'expense' || t.date !== today) return t;

        totalSoFar += t.amount;

        // Mark over-budget if needed
        if (totalSoFar <= newBudget) {
            // Within budget
            t.description = t.description.replace(' (over budget)', '').replace(' (within budget)', '') + ' (within budget)';
        } else {
            // Over budget
            t.description = t.description.replace(' (over budget)', '').replace(' (within budget)', '') + ' (over budget)';
        }

        return t;
    });

    // Save and update
    localStorage.setItem('budgetData', JSON.stringify({ transactions, dailyBudget }));
    budgetInput.value = '';
    updateDisplay();


    function clearBudget() {
  dailyBudget = 0;
  localStorage.setItem('budgetData', JSON.stringify({ transactions, dailyBudget }));
  updateDisplay();
}


        // Show quick expense modal
        function showQuickExpense() {
            document.getElementById('quickExpenseModal').style.display = 'block';
        }

        // Show quick income modal
        function showQuickIncome() {
            document.getElementById('quickIncomeModal').style.display = 'block';
        }

        function addQuickIncome() {
  const amountInput = document.getElementById('quickIncomeAmount');
  const amount = parseFloat(amountInput.value);

  if (isNaN(amount) || amount <= 0) {
    alert("Please enter a valid income amount.");
    return;
  }

  const now = new Date();
  const date = new Date().toLocaleDateString('en-CA');
  const time = now.toLocaleTimeString();

  transactions.push({
    id: Date.now(),
    description: 'Quick Income',
    amount,
    category: 'Income',
    type: 'income',
    date,
    time
  });

  amountInput.value = '';
  localStorage.setItem('budgetData', JSON.stringify({ transactions, dailyBudget }));
  updateDisplay();
}

        // Add quick expense
        function addQuickExpense() {
  const amount = parseFloat(document.getElementById('quickExpenseAmount').value);
  const description = document.getElementById('quickExpenseDesc').value.trim();

  if (!amount || amount <= 0) {
    alert("Please enter a valid amount.");
    return;
  }

  if (!description) {
    alert("Please enter 'What for?'.");
    return;
  }

  const now = new Date();
  const date = selectedDate;
  const time = now.toLocaleTimeString();
  const finalCategory = 'Other';

  // ✅ Total expenses for today
  const todayExpenses = transactions
    .filter(t => t.type === 'expense' && t.date === selectedDate)
    .reduce((sum, t) => sum + t.amount, 0);

  // ✅ Remaining = budget - todayExpenses + ticked over-budget amounts
  const remaining = dailyBudget - todayExpenses + adjustOverBudget;

  // ✅ Split logic
  const withinBudget = Math.max(0, Math.min(amount, remaining));
  const overBudgetPart = amount - withinBudget;

  if (withinBudget > 0) {
    transactions.push({
      id: Date.now(),
      description: description + ' (within budget)',
      amount: withinBudget,
      category: finalCategory,
      type: 'expense',
      date,
      time
    });
  }

  if (overBudgetPart > 0) {
    transactions.push({
      id: Date.now() + 1,
      description: description + ' (over budget)',
      amount: overBudgetPart,
      category: finalCategory,
      type: 'expense',
      date,
      time
    });
  }

  // ✅ Clean up
  document.getElementById('quickExpenseAmount').value = '';
  document.getElementById('quickExpenseDesc').value = '';
  closeModal('quickExpenseModal');

  allData[selectedDate] = { transactions, dailyBudget };
  localStorage.setItem('allBudgetData', JSON.stringify(allData));
  updateDisplay();
}







        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            function closeModal(id) {
    document.getElementById(id).style.display = 'none';
    document.body.classList.remove('modal-open');
    document.getElementById(id).classList.remove('modal-blur');
}

        }

        // Delete transaction
        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            updateDisplay();
        }

        // Filter transactions
        function filterTransactions(filter) {
    currentFilter = filter;

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase().includes(filter.replace('-', ' '))) {
            btn.classList.add('active');
        }
    });

    updateDisplay();
}


        // Get filtered transactions
        function getFilteredTransactions() {
    const allTransactions = Object.values(allData)
        .flatMap(entry => entry.transactions || []);

    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - 6); // 7 days total including today

    switch (currentFilter) {
        case 'today':
            return allTransactions.filter(t => t.date === todayStr);
        case 'yesterday':
            return allTransactions.filter(t => t.date === yesterdayStr);
        case 'week':
            return allTransactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= weekStart && tDate <= today;
            });
        case 'all':
        default:
            return allTransactions;
    }
}

function filterTransactions(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    updateDisplay();
}






        // Update display
        function updateDisplay() {
    const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    const balance = totalIncome - totalExpense;

    // Update balance display
    const balanceEl = document.getElementById('balance');
    balanceEl.textContent = `${balance.toFixed(2)} LKR`;
    balanceEl.className = `amount ${balance > 0 ? 'positive' : balance < 0 ? 'negative' : 'neutral'}`;

    // Update totals
    document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
    document.getElementById('totalExpense').textContent = totalExpense.toFixed(2);

    // ✅ FIXED: Use selectedDate instead of today
    const selectedOnlyExpenses = transactions
        .filter(t => t.type === 'expense' && t.date === selectedDate)
        .reduce((sum, t) => sum + t.amount, 0);

        let overBudgetUncheckedSum = transactions
    .filter(t => t.type === 'expense' &&
                 t.description.toLowerCase().includes('(over budget)') &&
                 !checkedOverBudgetIds.includes(t.id))
    .reduce((sum, t) => sum + t.amount, 0);

// ✅ Proper calculation: only add back unchecked over-budget amounts if the original over-budget transaction was from a previous budget limit.
let remaining = dailyBudget - selectedOnlyExpenses + adjustOverBudget;





    document.getElementById('remainingBudget').textContent = remaining.toFixed(2);

    // Update budget display
    document.getElementById('totalBudget').textContent = `${dailyBudget.toFixed(2)} LKR`;

    // ✅ FIXED: Progress bar also uses selectedDate
    const selectedDateExpenses = transactions.filter(t => t.type === 'expense' && t.date === selectedDate)
        .reduce((sum, t) => sum + t.amount, 0);
    const budgetProgress = dailyBudget > 0 ? (selectedDateExpenses / dailyBudget) * 100 : 0;
    document.getElementById('budgetProgress').style.width = `${Math.min(budgetProgress, 100)}%`;

    // Update transaction list
    updateTransactionsList();

    // Save complete state
    const appState = {
        transactions,
        dailyBudget,
        totalIncome,
        totalExpense,
        balance,
        remaining,
        checkedOverBudgetIds,
        adjustOverBudget,
        selectedDate
    };

    localStorage.setItem('budgetAppState', JSON.stringify(appState));
    allData[selectedDate] = { transactions, dailyBudget };
    localStorage.setItem('allBudgetData', JSON.stringify(allData));
}

        

        // Update transactions list
        // REPLACE the existing updateTransactionsList function (around line 650-700) with this:

        function updateTransactionsList() {
    const transactionsList = document.getElementById('transactionsList');
    const filteredTransactions = getFilteredTransactions();

    if (filteredTransactions.length === 0) {
        transactionsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No transactions found for the selected filter.</p>';
        return;
    }

    const grouped = groupTransactionsByDay(filteredTransactions);

    const html = grouped.map(group => {
        const dayBlock = `
            <div style="margin-bottom: 15px;">
                <h4 style="color: #ccc; border-bottom: 1px solid #555; margin-bottom: 10px;">
                    📅 ${new Date(group.date).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                </h4>
                ${group.transactions.map(transaction => `
                    <div class="transaction ${transaction.description.toLowerCase().includes('over budget') ? 'over-budget' : ''}" data-id="${transaction.id}">
  <div class="transaction-details">
    <div class="transaction-description">${transaction.description}</div>
    <div class="transaction-info">${transaction.category} • ${transaction.time}</div>
  </div>

  <div class="transaction-amount ${transaction.type} ${transaction.description.toLowerCase().includes('over budget') ? 'over-budget' : ''}">
    ${transaction.type === 'income' ? '+' : '-'}${transaction.amount.toFixed(2)} LKR
  </div>

  <button class="transaction-delete-btn" onclick="deleteTransaction(${transaction.id})">
    <svg viewBox="0 0 24 24">
      <path d="M9 3v1H4v2h16V4h-5V3H9zm-2 5v12a1 1 0 001 1h8a1 1 0 001-1V8H7zm2 2h2v8H9v-8zm4 0h2v8h-2v-8z"/>
    </svg>
  </button>

  ${transaction.description.toLowerCase().includes('over budget') ? `
    <div style="position: absolute; bottom: 4px; right: 4px;">
      <input type="checkbox" onchange="toggleOverBudgetCheck(${transaction.id})"
        ${checkedOverBudgetIds.includes(transaction.id) ? 'checked' : ''}>
    </div>
  ` : ''}
</div>



    <path d="M9 3v1H4v2h16V4h-5V3H9zm-2 5v12a1 1 0 001 1h8a1 1 0 001-1V8H7zm2 2h2v8H9v-8zm4 0h2v8h-2v-8z"/>
  </svg>
</button>

</div>

                    </div>
                `).join('')}
            </div>
        `;
        return dayBlock;
    }).join('');

    transactionsList.innerHTML = html;
}




let touchStartX = 0;
let touchStartY = 0;
let currentSwipeTransaction = null;
let isSwipeInProgress = false;

// Add this function to your script section (around line 600)
function initSwipeHandlers() {
    const transactionsList = document.getElementById('transactionsList');
    
    transactionsList.addEventListener('touchstart', handleTouchStart, { passive: false });
    transactionsList.addEventListener('touchmove', handleTouchMove, { passive: false });
    transactionsList.addEventListener('touchend', handleTouchEnd, { passive: false });
    
    // Mouse events for desktop testing
    transactionsList.addEventListener('mousedown', handleMouseDown);
    transactionsList.addEventListener('mousemove', handleMouseMove);
    transactionsList.addEventListener('mouseup', handleMouseUp);
    transactionsList.addEventListener('mouseleave', handleMouseUp);
}

function handleTouchStart(e) {
    const transaction = e.target.closest('.transaction');
    if (!transaction) return;
    
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    currentSwipeTransaction = transaction;
    isSwipeInProgress = true;
    
    transaction.classList.add('swiping');
}

function handleTouchMove(e) {
    if (!isSwipeInProgress || !currentSwipeTransaction) return;
    
    const touchX = e.touches[0].clientX;
    const touchY = e.touches[0].clientY;
    const deltaX = touchX - touchStartX;
    const deltaY = touchY - touchStartY;
    
    // Only allow horizontal swipe
    if (Math.abs(deltaY) > Math.abs(deltaX)) {
        return;
    }
    
    e.preventDefault();
    
    // Only allow left swipe
    if (deltaX < 0) {
        const swipeDistance = Math.min(Math.abs(deltaX), 80);
        currentSwipeTransaction.style.transform = `translateX(-${swipeDistance}px)`;
    }
}

function handleTouchEnd(e) {
    if (!isSwipeInProgress || !currentSwipeTransaction) return;
    
    const touchX = e.changedTouches[0].clientX;
    const deltaX = touchX - touchStartX;
    
    currentSwipeTransaction.classList.remove('swiping');
    
    if (deltaX < -40) {
        // Swipe left threshold met
        currentSwipeTransaction.classList.add('swipe-left');
        currentSwipeTransaction.style.transform = 'translateX(-80px)';
    } else {
        // Snap back
        currentSwipeTransaction.classList.remove('swipe-left');
        currentSwipeTransaction.style.transform = 'translateX(0)';
    }
    
    resetSwipeState();
}

// Mouse handlers for desktop
function handleMouseDown(e) {
    const transaction = e.target.closest('.transaction');
    if (!transaction) return;
    
    touchStartX = e.clientX;
    touchStartY = e.clientY;
    currentSwipeTransaction = transaction;
    isSwipeInProgress = true;
    
    transaction.classList.add('swiping');
}

function handleMouseMove(e) {
    if (!isSwipeInProgress || !currentSwipeTransaction) return;
    
    const deltaX = e.clientX - touchStartX;
    const deltaY = e.clientY - touchStartY;
    
    if (Math.abs(deltaY) > Math.abs(deltaX)) {
        return;
    }
    
    e.preventDefault();
    
    if (deltaX < 0) {
        const swipeDistance = Math.min(Math.abs(deltaX), 80);
        currentSwipeTransaction.style.transform = `translateX(-${swipeDistance}px)`;
    }
}

function handleMouseUp(e) {
    if (!isSwipeInProgress || !currentSwipeTransaction) return;
    
    const deltaX = e.clientX - touchStartX;
    
    currentSwipeTransaction.classList.remove('swiping');
    
    if (deltaX < -40) {
        currentSwipeTransaction.classList.add('swipe-left');
        currentSwipeTransaction.style.transform = 'translateX(-80px)';
    } else {
        currentSwipeTransaction.classList.remove('swipe-left');
        currentSwipeTransaction.style.transform = 'translateX(0)';
    }
    
    resetSwipeState();
}

function resetSwipeState() {
    isSwipeInProgress = false;
    currentSwipeTransaction = null;
    touchStartX = 0;
    touchStartY = 0;
}

function handleDeleteClick(id) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        deleteTransaction(id);
    }
}

// Call this function when the page loads (add to your window.onload or at the end of your script)
document.addEventListener('DOMContentLoaded', function() {
    initSwipeHandlers();
});










            function groupTransactionsByDay(transactions) {
    const grouped = {};

    transactions.forEach(transaction => {
        const date = transaction.date;
        if (!grouped[date]) {
            grouped[date] = [];
        }
        grouped[date].push(transaction);
    });

    // Sort dates descending
    const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

    return sortedDates.map(date => ({
        date,
        transactions: grouped[date].sort((a, b) => new Date(b.time) - new Date(a.time))
    }));
}

            
        

        // Clear all data
        // Find this function in your HTML file (around line 800-810)
// REPLACE the existing clearAllData function with this:

// Find this function in your HTML file (around line 800-810)
// REPLACE the existing clearAllData function with this:

function clearAllData() {
    if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
        // Reset all state variables
        transactions = [];
        dailyBudget = 0;
        checkedOverBudgetIds = [];
        adjustOverBudget = 0;
        
        // Clear the budget input field
        const budgetInput = document.getElementById('budgetInput');
        if (budgetInput) {
            budgetInput.value = '';
        }
        
        // Reset allData structure
        allData = {};
        
        // Save to localStorage
        localStorage.setItem('budgetAppState', JSON.stringify({
            transactions: [],
            dailyBudget: 0,
            totalIncome: 0,
            totalExpense: 0,
            balance: 0,
            remaining: 0,
            checkedOverBudgetIds: [],
            adjustOverBudget: 0,
            selectedDate: new Date().toLocaleDateString('en-CA')

        }));
        
        localStorage.setItem('allBudgetData', JSON.stringify({}));
        
        // Update display
        updateDisplay();
        
        alert('All data has been reset!');
    }
}

        // Export data
        function exportData() {
            const data = {
                transactions: transactions,
                dailyBudget: dailyBudget,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `budget_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Show statistics
        function showStatistics() {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            // Category breakdown
            const categoryStats = {};
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    categoryStats[t.category] = (categoryStats[t.category] || 0) + t.amount;
                }
            });

            // Daily spending
            const dailyStats = {};
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    dailyStats[t.date] = (dailyStats[t.date] || 0) + t.amount;
                }
            });

            const avgDaily = Object.values(dailyStats).reduce((a, b) => a + b, 0) / Object.keys(dailyStats).length || 0;

            const statsHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${transactions.length}</div>
                        <div class="stat-label">Total Transactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${avgDaily.toFixed(2)}</div>
                        <div class="stat-label">Avg Daily Spending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(categoryStats).length}</div>
                        <div class="stat-label">Categories Used</div>
                    </div>
                    <div class="stat-card">
    <div class="stat-number" id="remainingBudget">0</div>
    <div class="stat-label">Remaining</div>
</div>

                </div>
                <h3>Category Breakdown</h3>
                ${Object.entries(categoryStats).map(([cat, amount]) => `
                    <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                        <span>${cat}</span>
                        <span>${amount.toFixed(2)} LKR</span>
                    </div>
                `).join('')}
            `;

            document.getElementById('statisticsContent').innerHTML = statsHTML;
            document.getElementById('statisticsModal').style.display = 'block';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        // Restore data
function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';

    input.onchange = function (event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const data = JSON.parse(e.target.result);
                transactions = data.transactions || [];
                dailyBudget = data.dailyBudget || 0;
                updateDisplay();
                alert('Backup restored successfully!');
            } catch (error) {
                alert('Failed to restore backup. Invalid file format.');
            }
        };
        reader.readAsText(file);
    };

    input.click();
}
function toggleQuickMenu() {
    const menu = document.getElementById('quickActionMenu');
    menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
}

function hideQuickMenu() {
    document.getElementById('quickActionMenu').style.display = 'none';
}
function isOverBudget(transaction) {
    if (transaction.type !== 'expense') return false;

    // Check if description contains "(over budget)"
    return transaction.description.toLowerCase().includes('(over budget)');
}

window.addEventListener("click", function(event) {
  const modal = document.getElementById("myModal"); // Change to your modal ID
  if (modal && modal.style.display === "block" && !modal.contains(event.target)) {
    modal.style.display = "none";
  }
});
window.firstTimeBudgetSet = true;


function toggleOverBudgetCheck(id) {
  const idx = checkedOverBudgetIds.indexOf(id);

  if (idx === -1) {
    // ✅ Tick: ADD to checked list
    checkedOverBudgetIds.push(id);
  } else {
    // ❌ Untick: REMOVE from checked list
    checkedOverBudgetIds.splice(idx, 1);
  }

  // ✅ Update total checked-over-budget amount
  adjustOverBudget = transactions
    .filter(t =>
      t.type === 'expense' &&
      t.description.toLowerCase().includes('(over budget)') &&
      checkedOverBudgetIds.includes(t.id)
    )
    .reduce((sum, t) => sum + t.amount, 0);

  localStorage.setItem('checkedOverBudgetIds', JSON.stringify(checkedOverBudgetIds));
  updateDisplay();
}




    </script>
    
</body>
</html>
